#include <iostream>
#include <vector>
#include <fstream>
#include <string>
#include <windows.h>
#include <cstdio>
#include <math.h>
#include <algorithm>

//#define byte int8_t;

using namespace std;

vector<double>freq(128);
vector<string>noteNames={"ฤ๎","ฤ๎#","ะๅ","ะๅ#","ฬ่","ิเ","ิเ#","ั๎๋","ั๎๋#","ห","ห#","ั่"};

string readStr4(ifstream &in) {
    string r = "";
    for (int i = 0; i < 4; ++i)
        r += char(in.get());
    return r;
}

uint32_t readInt(ifstream &in) {
    char buffer[4];
    for (int i = 0; i < 4; ++i)
        in.get(buffer[i]);
    return uint32_t((unsigned char) (buffer[0]) << 24 |
                    (unsigned char) (buffer[1]) << 16 |
                    (unsigned char) (buffer[2]) << 8 |
                    (unsigned char) (buffer[3]));
}

uint16_t readShort(ifstream &in) {
    char buffer[2];
    for (int i = 0; i < 2; ++i)
        in.get(buffer[i]);
    return uint16_t((unsigned char) (buffer[0]) << 8 | (unsigned char) (buffer[1]));
}

struct Note {
    int time = 0;
    int freq = 0;
    bool pressed = false;
    int num = 0;
    int vol = 0;
    int channel = 0;

};

vector<vector<Note>> blocks;

bool timecmp(Note a, Note b){
    return a.time<b.time;
}

Note tNote;

void readDataBlock(ifstream &in) {
    vector<Note> cblock;
    string nameSection = readStr4(in);
    uint32_t lengthSection = readInt(in); // 4 ???? ?????? ??? ?????.
    uint32_t LoopIndex = lengthSection; // ?????? ???????? ??????? ???. ??? ?????? ????, ???? ???? ?? ??? = 0.
    uint32_t realTime = 0; // ?????? ??? ????? ?????.
    while (LoopIndex != 0) // ???? ?? ???? ?? ????.
    {


        // ??? ????????? ??????? ??? ????. ?????? ???? ?? ????? 8-?? ???? ??? (???? ?????).
        int loopCount = 0; // ???????? ?????? ????.
        uint8_t buffer; // ?? ?????? ?????? ??????.
        uint32_t bufferTime = 0; // ?????? ??? ?????? ??.
        do {
            buffer = in.get(); // ???? ??????.
            loopCount++; // ????????, ?? ???? ????.
            bufferTime <<= 7; // ???????? ?? 7 ???? ????? ???????? ?????? ????? (?.?. 1 ???? ???? ?? ????????).
            bufferTime |= uint8_t(
                    uint8_t(buffer) & uint8_t(0x7F)); // ?? ?????? ???? ????????? ???????? ???.
        } while ((buffer & (1 << 7)) != 0); // ?????, ??? ?? ????? ??????? ???? ????? (???? ??? = 0).
        realTime += bufferTime; // ?????? ???? ???.

        buffer = in.get();
        loopCount++; // ?????? ?????-????, ????????, ?? ???? ????.
        // ?? ? ??? ???-????, ?...
        if (buffer == 0xFF) {
            buffer = in.get();  // ?????? ????? ???-????.
            buffer = in.get();  // ?????? ?????.
            loopCount += 2;
            for (int loop = 0; loop < buffer; loop++)
                in.get();
            LoopIndex = LoopIndex - loopCount - buffer; // ?????? ?? ????? ?????? ???????.
        }

            // ?? ?? ???-???, ? ???, ????? ?? ??? ???? ????? ????.
        else
            switch ((int8_t) buffer & 0xF0) // ????? ?? ????? 4-? ????.
            {
                // ?????? ???? ????? ????.

                case 0x80: // ????? ???????
                    tNote.channel = (buffer & 0x0F); // ?????? ????? ??????.
                    tNote.pressed = false; // ?? ?????? ???????.
                    tNote.num = in.get();
                    tNote.vol = in.get();
                    tNote.time = realTime; // ???????? ???? ??? ????.
                    cblock.push_back(tNote);
                    LoopIndex = LoopIndex - loopCount - 2; // ?????? ???????.
                    break;
                case 0x90:   // ?????? ???????.

                    tNote.channel = (buffer & 0x0F); // ?????? ????? ??????.
                    tNote.pressed = true; // ?? ????????.
                    tNote.num = in.get(); // ?????? ????? ????.
                    tNote.vol = in.get(); // ?????? ???????? ????.
                    tNote.time = realTime;  // ???????? ???? ??? ????.
                    cblock.push_back(tNote); // ????? ????? ????????.
                    LoopIndex = LoopIndex - loopCount - 2; // ?????? ???????.
                    break;
                case 0xA0:  // ??????? ?? ?????? ???????.
                    tNote.channel = (buffer & 0x0F); // ?????? ????? ??????.
                    tNote.pressed = true; // ?? ????????.
                    tNote.num = in.get(); // ?????? ????? ????.
                    tNote.vol = in.get(); // ?????? ????? ???????? ????.
                    tNote.time = realTime; // ???????? ???? ??? ????.
                    cblock.push_back(tNote);  // ????? ????? ????????.
                    LoopIndex = LoopIndex - loopCount - 2; // ?????? ???????.
                    break;
                    // ?? 2-? ?????? ????????.
                case 0xB0: {
                    uint8_t buffer2level = in.get();  // ???? ?? ???????.
                    in.get();  // ?????? ?????? ?????-? ????????? ???.
                    LoopIndex = LoopIndex - loopCount - 2; // ?????? ???????.
                    /*switch (buffer2level) // ????? ??????? ???? ????.
                    {
                        //default:  ??? ????????? ????? ??????? (?? ??????).
                            in.get();  // ?????? ?????? ?????-? ????????? ???.
                            LoopIndex = LoopIndex - loopCount - 2; // ?????? ???????.
                            break;
                    }*/
                };
                    break;

                    // ? ??? ????????? ?? ???? ??? ?????.
                case 0xC0:   // ???? ?????? ???? ?????.
                    in.get();  // ?????? ????? ?????.
                    LoopIndex = LoopIndex - loopCount - 1; // ?????? ???????.
                    break;

                case 0xD0:   // ???? ??????.
                    in.get();  // ?????? ????? ?????.
                    LoopIndex = LoopIndex - loopCount - 1; // ?????? ???????.
                    break;

                case 0xE0:  // ????? ????????? ?????.
                    in.get();
                    in.get();
                    LoopIndex = LoopIndex - loopCount - 2; // ?????? ???????.
                    break;
            }
    }
    blocks.push_back(cblock);
}

void loadMidi(string filename) {
    ifstream in(filename);

    int infoSize, fileType, blockCnt, timeFormat;
    readStr4(in);
    infoSize = readInt(in);
    fileType = readShort(in);
    blockCnt = readShort(in);
    timeFormat = readShort(in);
    char c;

    for (int bn=0;bn<blockCnt;++bn)
        readDataBlock(in);
    while ((c = in.get()) != EOF) {
        cout << hex << c + 0 << ' ';
    }
    in.close();
    for (auto &i:blocks)
        sort(i.begin(),i.end(), timecmp);
    for (auto &i:blocks){
        for (auto j:i)
            cout << noteNames[j.num%12] << ' ';
        cout << '\n';


    }


}

// A 81 prob 57
int main() {

    SetConsoleCP(1251);
    SetConsoleOutputCP(1251);
    double step=pow(2,1.0/12.0);
    freq[57]=440;
    for (int i=58;i<57+12;++i)
        freq[i]=freq[i-1]*step;
    for (int i=57+12;i<128;++i)
        freq[i]=freq[i-12]*2;
    for (int i=56;i>=0;--i)
        freq[i]=freq[i+12]/2;


    //loadMidi("test1.mid");
    loadMidi("D:\\Programming\\VS_CPP\\RandomThings\\midiReader\\test2.mid");


    return 0;
}
